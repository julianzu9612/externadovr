<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Externado VR - Experiencia de Museo AR</title>

    <!-- A-Frame y MindAR -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <link rel="preload" as="video" href="./assets/videos/rector1.mp4" crossorigin="anonymous">
    <link rel="preload" as="video" href="./assets/videos/rector2.mp4" crossorigin="anonymous">

    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Ocultar UI de carga nativa de MindAR para personalizarla */
        .mindar-ui-loading {
            display: none !important;
        }

        /* UI de Carga y Escaneo */
        #ui-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            z-index: 1000;
            transition: opacity 0.5s;
        }

        #ui-container.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .scan-guide {
            width: 250px;
            height: 250px;
            border: 4px solid #fff;
            border-radius: 20px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            margin-bottom: 20px;
            position: relative;
        }

        .scan-line {
            position: absolute;
            width: 100%;
            height: 4px;
            background: #00ffcc;
            bottom: 0;
            animation: scan 2s infinite ease-in-out;
        }

        @keyframes scan {
            0% {
                top: 0;
            }

            50% {
                top: 100%;
            }

            100% {
                top: 0;
            }
        }

        h1 {
            font-size: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
        }

        p {
            font-size: 1rem;
            opacity: 0.8;
            text-align: center;
        }

        /* Botón para activar audio (necesario por políticas de navegador) */
        #play-button {
            padding: 15px 30px;
            background: #00ffcc;
            color: black;
            border: none;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            font-size: 1rem;
        }
    </style>
</head>

<body>

    <div id="ui-container">
        <div class="scan-guide">
            <div class="scan-line"></div>
        </div>
        <h1>Experiencia AR: Rectores</h1>
        <p>Apunta a los cuadros de Diego Mendoza o Ricardo Hinestrosa</p>
        <button id="play-button">INICIAR EXPERIENCIA</button>
        <div id="debug-console"
            style="position:fixed; bottom:0; left:0; width:100%; height:100px; background:rgba(0,0,0,0.5); color:lime; font-size:10px; overflow-y:scroll; pointer-events:none; z-index:9999; display:none;">
        </div>
    </div>

    <!-- Escena AR -->
    <!-- uiLoading:yes (default) pero oculto con CSS, evita crash en Safari -->
    <a-scene
        mindar-image="imageTargetSrc: ./assets/targets/targets.mind; autoStart: false; uiLoading: yes; uiScanning: no; filterMinCF:0.0001; filterBeta: 0.001;"
        color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false">

        <a-assets>
            <video id="video-rector-1" src="./assets/videos/rector1.mp4" preload="auto" loop="true"
                crossOrigin="anonymous" playsinline webkit-playsinline></video>
            <video id="video-rector-2" src="./assets/videos/rector2.mp4" preload="auto" loop="true"
                crossOrigin="anonymous" playsinline webkit-playsinline></video>
        </a-assets>

        <!-- Cámara con Cursor (Raycaster) -->
        <a-camera position="0 0 0" look-controls="enabled: false" cursor="fuse: false; rayOrigin: mouse;"
            raycaster="far: 10000; objects: .clickable">
            <!-- Cursor Visual (Punto central para saber dónde tocas) -->
            <a-entity cursor="fuse: true; fuseTimeout: 500" position="0 0 -1"
                geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03" material="color: white; shader: flat">
            </a-entity>
        </a-camera>

        <!-- ================================================================== -->
        <!-- RECTOR 1: DIEGO MENDOZA (TARGET 1) -->
        <!-- ================================================================== -->
        <a-entity mindar-image-target="targetIndex: 1" id="target-rector-1">

            <!-- Video Principal (Plano) -->
            <a-video id="ar-video-1" src="#video-rector-1" width="1" height="1.4" position="0 0 0"></a-video>

            <!-- ANILLO ORBITAL (Torus System) -->
            <a-entity rotation="60 0 0"
                animation="property: rotation; to: 60 360 0; loop: true; dur: 20000; easing: linear">
                <a-torus color="#FFD700" radius="0.8" radius-tubular="0.01" segments-tubular="64"
                    material="metalness: 0.8; roughness: 0.2; opacity: 0.8"></a-torus>

                <!-- Esferas Interactivas (Nodos de información) -->
                <a-sphere class="clickable" color="#FFD700" radius="0.08" position="0.8 0 0"
                    event-set__click="_event: click; scale: 1.2 1.2 1.2"
                    animation="property: scale; dir: alternate; dur: 1000; to: 1.1 1.1 1.1; loop: true" data-type="bio">
                </a-sphere>

                <a-sphere class="clickable" color="#00FFFF" radius="0.08" position="-0.4 0.69 0"
                    animation="property: scale; dir: alternate; dur: 1200; to: 1.1 1.1 1.1; loop: true"
                    data-type="legacy">
                </a-sphere>

                <a-sphere class="clickable" color="#FF4444" radius="0.08" position="-0.4 -0.69 0"
                    animation="property: scale; dir: alternate; dur: 1400; to: 1.1 1.1 1.1; loop: true"
                    data-type="quote">
                </a-sphere>
            </a-entity>

            <!-- Paneles de Texto -->
            <a-entity id="panel-bio" visible="false" position="1.2 0 0">
                <a-plane color="#000" opacity="0.8" width="1" height="1.2"></a-plane>
                <a-text
                    value="DIEGO MENDOZA PEREZ\n\n(1857-1933)\n\nRector del Externado (1900-1933).\nDefensor de las ideas liberales y la educación laica."
                    align="center" width="0.9" position="0 0 0.01"></a-text>
            </a-entity>

            <a-entity id="panel-legacy" visible="false" position="-1.2 0.5 0">
                <a-plane color="#000" opacity="0.8" width="1" height="0.8"></a-plane>
                <a-text value="VISIONARIO\n\nConsolidó la universidad moderna y promovió la libertad de cátedra."
                    align="center" width="0.9" position="0 0 0.01"></a-text>
            </a-entity>

            <a-entity id="panel-quote" visible="false" position="-1.2 -0.5 0">
                <a-plane color="#000" opacity="0.8" width="1" height="0.8"></a-plane>
                <a-text value="LIBERTAD\n\n'La educación es el camino hacia la verdadera libertad de los pueblos'."
                    align="center" width="0.9" position="0 0 0.01"></a-text>
            </a-entity>
        </a-entity>

        <!-- ================================================================== -->
        <!-- RECTOR 2: RICARDO HINESTROZA (TARGET 0) -->
        <!-- ================================================================== -->
        <a-entity mindar-image-target="targetIndex: 0" id="target-rector-2">

            <!-- Video Principal (El Constructor - Casa Propia) -->
            <a-video id="ar-video-2" src="#video-rector-2" width="1" height="1" position="0 0 0"></a-video>

            <!-- LÍNEA DE TIEMPO INTERACTIVA -->
            <a-entity position="0 -0.6 0.1" scale="0.8 0.8 0.8">

                <a-box color="#FFD700" width="1.8" height="0.05" depth="0.05" position="0 0 0"
                    material="metalness: 0.8; roughness: 0.2"></a-box>

                <!-- Nodo 1933 -->
                <a-entity position="-0.7 0.1 0">
                    <a-sphere class="clickable" color="#000088" radius="0.12"
                        event-set__click="_event: click; scale: 1.2 1.2 1.2"
                        animation="property: position; to: -0.7 0.15 0; dir: alternate; loop: true; dur: 2000"
                        data-type="rectorado">
                    </a-sphere>
                    <a-text value="1933" align="center" position="0 -0.2 0" width="2" color="white"></a-text>
                </a-entity>

                <!-- Nodo 1942 -->
                <a-entity position="0 0.1 0">
                    <a-box class="clickable" color="#FF4444" width="0.25" height="0.25" depth="0.25"
                        animation="property: rotation; to: 0 360 0; loop: true; dur: 10000" data-type="casa">
                    </a-box>
                    <a-text value="1942" align="center" position="0 -0.25 0" width="2.5" color="#FFD700"
                        font="exo2bold"></a-text>
                </a-entity>

                <!-- Nodo 1963 -->
                <a-entity position="0.7 0.1 0">
                    <a-sphere class="clickable" color="#008800" radius="0.12"
                        animation="property: position; to: 0.7 0.05 0; dir: alternate; loop: true; dur: 2500"
                        data-type="jurista">
                    </a-sphere>
                    <a-text value="1963" align="center" position="0 -0.2 0" width="2" color="white"></a-text>
                </a-entity>
            </a-entity>

            <!-- MODELO 3D (Optimizado) -->
            <a-entity gltf-model="./assets/models/rector2_opt.glb" scale="0.5 0.5 0.5" position="1.2 -0.4 0.2"
                rotation="0 -30 0" animation="property: rotation; to: 0 330 0; loop: true; dur: 15000; easing: linear">
            </a-entity>

            <!-- Paneles R2 -->
            <a-entity id="info-panel-rectorado" visible="false" position="-1.2 0 0.2">
                <a-plane width="1.2" height="1.5" color="#111" opacity="0.9" material="shader: flat">
                    <a-text value="EL GRAN RECTOR (1933-1963)\n\n30 años defendiendo la libertad de cátedra."
                        align="center" width="1" color="white" wrap-count="20"></a-text>
                </a-plane>
            </a-entity>

            <a-entity id="info-panel-casa" visible="false" position="0 0.8 0.3">
                <a-plane width="1.4" height="0.8" color="#300" opacity="0.95" border="color: gold; width: 0.05">
                    <a-text value="LA CASA PROPIA\n\n'El Externado tiene casa propia, la criatura no morirá'."
                        align="center" width="1.3" color="#FFD700" wrap-count="25"></a-text>
                </a-plane>
            </a-entity>

            <a-entity id="info-panel-jurista" visible="false" position="1.2 0 0.2">
                <a-plane width="1.2" height="1.5" color="#030" opacity="0.9">
                    <a-text value="EL JURISTA MODERNO\n\nPresidente de la Corte Suprema (1936)." align="center"
                        width="1" color="white" wrap-count="20"></a-text>
                </a-plane>
            </a-entity>

        </a-entity>

    </a-scene>

    <script>
        const uiContainer = document.getElementById('ui-container');
        const playButton = document.getElementById('play-button');
        const sceneEl = document.querySelector('a-scene');
        const video1 = document.querySelector('#video-rector-1');
        const video2 = document.querySelector('#video-rector-2');
        const debugConsole = document.getElementById('debug-console');

        // Función para logging en pantalla (Debug Mode)
        function logMsg(msg) {
            console.log(msg);
            // Descomentar para ver logs en pantalla del celular
            // debugConsole.style.display = 'block';
            // debugConsole.innerHTML += "<div>" + msg + "</div>";
        }

        // --- FIX RACE CONDITION START ---
        playButton.disabled = true;
        playButton.innerText = "CARGANDO MOTOR...";
        playButton.style.opacity = "0.5";
        playButton.style.cursor = "not-allowed";

        sceneEl.addEventListener('loaded', () => {
            logMsg("Scene Loaded! Enabling Start Button.");
            playButton.disabled = false;
            playButton.innerText = "INICIAR EXPERIENCIA";
            playButton.style.opacity = "1";
            playButton.style.cursor = "pointer";
        });

        if (sceneEl.hasLoaded) {
            logMsg("Scene already loaded.");
            playButton.disabled = false;
            playButton.innerText = "INICIAR EXPERIENCIA";
            playButton.style.opacity = "1";
            playButton.style.cursor = "pointer";
        }
        // --- FIX RACE CONDITION END ---

        playButton.addEventListener('click', async () => {
            playButton.innerText = "CARGANDO...";
            uiContainer.style.background = "rgba(0,0,0,0.95)";

            try {
                logMsg("Warming up videos...");

                video1.muted = true;
                video2.muted = true;

                // Intentar reproducir ambos
                try {
                    await video1.play().then(() => { video1.pause(); video1.currentTime = 0; }).catch(e => logMsg("V1 err: " + e));
                    await video2.play().then(() => { video2.pause(); video2.currentTime = 0; }).catch(e => logMsg("V2 err: " + e));
                } catch (e) {
                    logMsg("Video warm-up error: " + e);
                }

                video1.muted = false;
                video2.muted = false;

                logMsg("Starting MindAR...");
                await sceneEl.systems["mindar-image-system"].start();

                uiContainer.classList.add('hidden');
                logMsg("MindAR Ready!");
            } catch (error) {
                logMsg("Error crítico: " + error);
                playButton.innerText = "ERROR - RECARGAR";
                alert("Error al iniciar la experiencia: " + error);
            }
        });

        // LÓGICA DE DETECCIÓN
        const target1 = document.querySelector('#target-rector-1');
        if (target1) {
            target1.addEventListener("targetFound", () => {
                logMsg("Rector 1 Found");
                video1.play();
            });
            target1.addEventListener("targetLost", () => {
                logMsg("Rector 1 Lost");
                video1.pause();
            });
        }

        const target2 = document.querySelector('#target-rector-2');
        if (target2) {
            target2.addEventListener("targetFound", () => {
                logMsg("Rector 2 Found");
                video2.play();
            });
            target2.addEventListener("targetLost", () => {
                logMsg("Rector 2 Lost");
                video2.pause();
            });
        }

        // LÓGICA DE INTERACCIÓN GLOBAL
        function showInfo(type) {
            // Ocultar todos
            const allPanels = ['bio', 'legacy', 'quote', 'rectorado', 'casa', 'jurista'];
            allPanels.forEach(p => {
                let el = document.getElementById('panel-' + p);
                if (!el) el = document.getElementById('info-panel-' + p);

                if (el) el.setAttribute('visible', false);
            });

            // Mostrar seleccionado (Buscar con ambos prefijos por si acaso)
            let selectedPanel = document.getElementById('panel-' + type);
            if (!selectedPanel) selectedPanel = document.getElementById('info-panel-' + type);

            if (selectedPanel) {
                selectedPanel.setAttribute('visible', true);
                selectedPanel.object3D.scale.set(1, 0, 1);
                selectedPanel.setAttribute('animation', 'property: scale; to: 1 1 1; dur: 400; easing: easeOutQuad');
            }
        }

        document.querySelectorAll('.clickable').forEach(el => {
            el.addEventListener('click', () => {
                const type = el.getAttribute('data-type');
                if (type) showInfo(type);
            });
        });
    </script>
</body>

</html>